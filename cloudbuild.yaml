steps:
  #############################################
  # 0. GKE ÌÅ¥Îü¨Ïä§ÌÑ∞ Ïù∏Ï¶ù ÏÑ§Ï†ï
  #############################################
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîë Getting GKE cluster credentials..."
        gcloud container clusters get-credentials autopilot-cluster-1 \
          --region asia-northeast3 \
          --project steel-fin-459711-k9

  #############################################
  # 1. GCP ÏÑúÎπÑÏä§ Í≥ÑÏ†ï ÌÇ§ Secret ÏÉùÏÑ±
  #############################################
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üîê Creating Kubernetes Secret for GCP key..."

        # Í∏∞Ï°¥ secret ÏÇ≠Ï†ú (ÏûàÏúºÎ©¥)
        kubectl delete secret capstone-secrets --ignore-not-found

        # Secret ÏÉùÏÑ±
        kubectl create secret generic capstone-secrets \
          --from-literal=GCP_SA_KEY_BASE64="${_GCP_SA_KEY}" \
          --from-literal=GOOGLE_CLOUD_STORAGE_BUCKET="steel-fin-459711-k9-01424cceaf04" \
          --from-literal=GOOGLE_CLOUD_PROJECT_ID="steel-fin-459711-k9" \
          --from-literal=KAKAO_API_KEY="1e1e4cdde8201f18aacae19257f3fffa"
    env:
      - _GCP_SA_KEY=${_GCP_SA_KEY}

  #############################################
  # 2. Express (Node.js ÏÑúÎ≤Ñ) ÎπåÎìú Î∞è Î∞∞Ìè¨
  #############################################
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - asia.gcr.io/steel-fin-459711-k9/capstone-server:$SHORT_SHA
      - -f
      - code/node/Dockerfile
      - .

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - asia.gcr.io/steel-fin-459711-k9/capstone-server:$SHORT_SHA

  - name: gcr.io/cloud-builders/kubectl
    args:
      - set
      - image
      - deployment/capstone-express
      - capstone-server-sha256-1=asia.gcr.io/steel-fin-459711-k9/capstone-server:$SHORT_SHA
    env:
      - CLOUDSDK_COMPUTE_REGION=asia-northeast3
      - CLOUDSDK_CONTAINER_CLUSTER=autopilot-cluster-1

  #############################################
  # 3. Flask (Python AI ÏÑúÎ≤Ñ) ÎπåÎìú Î∞è Î∞∞Ìè¨
  #############################################
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - asia.gcr.io/steel-fin-459711-k9/capstone-flask:$SHORT_SHA
      - -f
      - code/python/Dockerfile
      - code/python

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - asia.gcr.io/steel-fin-459711-k9/capstone-flask:$SHORT_SHA

  - name: gcr.io/cloud-builders/kubectl
    args:
      - set
      - image
      - deployment/capstone-ai
      - flask-ai-server-sha256-1=asia.gcr.io/steel-fin-459711-k9/capstone-flask:$SHORT_SHA
    env:
      - CLOUDSDK_COMPUTE_REGION=asia-northeast3
      - CLOUDSDK_CONTAINER_CLUSTER=autopilot-cluster-1

images:
  - asia.gcr.io/steel-fin-459711-k9/capstone-server:$SHORT_SHA
  - asia.gcr.io/steel-fin-459711-k9/capstone-flask:$SHORT_SHA

options:
  logging: CLOUD_LOGGING_ONLY
